<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Adventurer's Codex</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" type="text/css">
    <link rel="stylesheet" href="../css/bootstrap.css">
    <link rel="stylesheet" href="../css/cayman.css">
    <link rel="stylesheet" href="../css/prism.css">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Adventurer's Codex</h1>
      <h2 class="project-tagline">A tool to help D&amp;D 5e players keep their ducks in a row.</h2><a href="https://npmjs.com/package/Chractersheet" target="_blank" class="btn">View on npm</a>
    </section>
    <section data-spy="scroll" data-target=".scrollspy" class="main-content">
      <div class="row">
        <div class="col-md-3 col-xs-3 bs-docs-sidebar">
          <ul id="sidebar" class="nav nav-stacked fixed">
            <li><a href="../index.html">Main</a></li>
            <li><a href="../models/ability_scores.js.html">models/ability_scores.js</a></li>
            <li><a href="../models/appearance.js.html">models/appearance.js</a></li>
            <li><a href="../models/armor.js.html">models/armor.js</a></li>
            <li><a href="../models/campaign.js.html">models/campaign.js</a></li>
            <li><a href="../models/character.js.html">models/character.js</a></li>
            <li><a href="../models/chat_message.js.html">models/chat_message.js</a></li>
            <li><a href="../models/connection_manager.js.html">models/connection_manager.js</a></li>
            <li><a href="../models/death_save.js.html">models/death_save.js</a></li>
            <li><a href="../models/feat_traits.js.html">models/feat_traits.js</a></li>
            <li><a href="../models/feats_prof.js.html">models/feats_prof.js</a></li>
            <li><a href="../models/health.js.html">models/health.js</a></li>
            <li><a href="../models/hit_dice.js.html">models/hit_dice.js</a></li>
            <li><a href="../models/hit_dice_type.js.html">models/hit_dice_type.js</a></li>
            <li><a href="../models/image.js.html">models/image.js</a></li>
            <li><a href="../models/item.js.html">models/item.js</a></li>
            <li><a href="../models/magic_item.js.html">models/magic_item.js</a></li>
            <li><a href="../models/note.js.html">models/note.js</a></li>
            <li><a href="../models/npc.js.html">models/npc.js</a></li>
            <li><a href="../models/other_stats.js.html">models/other_stats.js</a></li>
            <li><a href="../models/player_info.js.html">models/player_info.js</a></li>
            <li><a href="../models/player_summary.js.html">models/player_summary.js</a></li>
            <li><a href="../models/player_types.js.html">models/player_types.js</a></li>
            <li><a href="../models/profile.js.html">models/profile.js</a></li>
            <li><a href="../models/saving_throws.js.html">models/saving_throws.js</a></li>
            <li><a href="../models/skill.js.html">models/skill.js</a></li>
            <li><a href="../models/spell.js.html">models/spell.js</a></li>
            <li><a href="../models/spell_slot.js.html">models/spell_slot.js</a></li>
            <li><a href="../models/spell_stats.js.html">models/spell_stats.js</a></li>
            <li><a href="../models/treasure.js.html">models/treasure.js</a></li>
            <li><a href="../models/user_notification.js.html">models/user_notification.js</a></li>
            <li><a href="../models/weapon.js.html">models/weapon.js</a></li>
            <li class="active"><a href="../services/persistence_service.js.html">services/persistence_service.js
                <ul class="nav nav-stacked">
                  <li><a href="#findAll"><i class="alert alert-info"></i><span>findAll</span></a>
                  </li>
                  <li><a href="#save"><i class="alert alert-info"></i><span>save</span></a>
                  </li>
                  <li><a href="#delete"><i class="alert alert-info"></i><span>delete</span></a>
                  </li>
                  <li><a href="#listAll"><i class="alert alert-info"></i><span>listAll</span></a>
                  </li>
                  <li><a href="#register"><i class="alert alert-info"></i><span>register</span></a>
                  </li>
                  <li><a href="#PersistenceServiceToken"><i class="alert alert-info"></i><span>PersistenceServiceToken</span></a>
                  </li>
                  <li><a href="#findAll"><i class="alert alert-info"></i><span>findAll</span></a>
                  </li>
                  <li><a href="#save"><i class="alert alert-info"></i><span>save</span></a>
                  </li>
                  <li><a href="#delete"><i class="alert alert-info"></i><span>delete</span></a>
                  </li>
                </ul></a></li>
            <li><a href="../services/player_summary_service.js.html">services/player_summary_service.js</a></li>
            <li><a href="../services/players_service.js.html">services/players_service.js</a></li>
            <li><a href="../services/sort_service.js.html">services/sort_service.js</a></li>
            <li><a href="../utilities/character_manager.js.html">utilities/character_manager.js</a></li>
            <li><a href="../utilities/fixtures.js.html">utilities/fixtures.js</a></li>
            <li><a href="../utilities/messenger.js.html">utilities/messenger.js</a></li>
            <li><a href="../utilities/notifications.js.html">utilities/notifications.js</a></li>
          </ul>
        </div>
        <div class="col-md-9">
          <section id="findAll">
            <h1>findAll</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>PersistenceService.findAll()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Given a model class, return all of the stored instances of that class.</p><h2>Parameters</h2>
<p>model: The prototype for the type of model that is being searched for. </p><h2>Returns</h2>
<p>A list of objects of the desired type.</p><h2>Usage</h2>
<pre><code class="lang-javascript">function Person() {...}

var people = PersistenceService.findAll(Person);
</code></pre>
</div>
          <pre><code class="language-javascript">PersistenceService.findAll = function(model) {
	return PersistenceService._findAll(model);
};</code></pre>
          <section id="save">
            <h1>save</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>PersistenceService.save()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Given a model class and an instance of that class, save the instance.</p><h2>Parameters</h2>
<p>inst: The object you would like to persist.<br />model: The prototype function that created the inst variable. </p><h2>Usage</h2>
<pre><code class="lang-javascript">function Person() {...}

PersistenceService.save(Person, new Person());
</code></pre>
</div>
          <pre><code class="language-javascript">PersistenceService.save = function(model, inst) {
	PersistenceService._save(model.name, inst);
};</code></pre>
          <section id="delete">
            <h1>delete</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>PersistenceService.delete()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Given a model class and an id, delete the instance with the given id.</p><h2>Parameters</h2>
<p>model: The prototype function for a given object type.<br />id: The index of the variable to be deleted. This value can be found in<br />    its the __id property. </p><h2>Usage</h2>
<pre><code class="lang-javascript">function Person() {...}

PersistenceService.delete(Person, 10);

// or

var bob = new Person();
PersistenceService.delete(Person, bob.__id);
</code></pre>
</div>
          <pre><code class="language-javascript">PersistenceService.delete = function(model, id) {
	PersistenceService._delete(model.name, id);
};

PersistenceService.drop = function(table) {
	PersistenceService._findAllObjs(table).forEach(function(e, i, _) {
		PersistenceService._delete(table, e.id)
	});
};</code></pre>
          <section id="listAll">
            <h1>listAll</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>PersistenceService.listAll()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>List all of the existing tables.</p></div>
          <pre><code class="language-javascript">PersistenceService.listAll = function() {
	return PersistenceService._listAll();
};

PersistenceService.dropAll = function() {
	PersistenceService.listAll().forEach(function(table, i1, _1) {
		PersistenceService.drop(table);
	});
};</code></pre>
          <section id="register">
            <h1>register</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>PersistenceService.register()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Register a given model as persisting. Typical usage of this class<br />will mean that this should be the only method needed from this class.<br />Once registered, use the PersistenceServiceToken API for shortcut methods.</p><h2>Parameters</h2>
<p>model: The prototype function that created the inst variable.<br />inst: The object you would like to persist.</p><h2>Returns</h2>
<p>A configured PersistenceServiceToken instance.</p><h2>Usage</h2>
<pre><code class="lang-javascript">function Person() {
        var self = this;
        self.ps = PersistenceService.register(Person, self);
}
</code></pre>
</div>
          <pre><code class="language-javascript">PersistenceService.register = function(model, inst) {
	return new PersistenceServiceToken(model, inst);	
};	

//======================= PersistenceServiceToken =============================</code></pre>
          <section id="PersistenceServiceToken">
            <h1>PersistenceServiceToken</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">function</div><span>&nbsp;</span><span>PersistenceServiceToken()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>A shortcut object for managing a single model object, once it has been registered.</p></div>
          <pre><code class="language-javascript">function PersistenceServiceToken(model, inst) {
	var self = this;
	
	self.model = model;
	self.inst = inst;</code></pre>
          <section id="findAll">
            <h1>findAll</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>self.findAll()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Return all of the stored instances of the configured class.</p><h2>Returns</h2>
<p>A list of objects of the desired type.</p><h2>Usage</h2>
<pre><code class="lang-javascript">function Person() {
        var self = this;
        self.ps = PersistenceService.register(Person, self);

        self.findAll = function() {
            var people = self.ps.findAll(Person);
        };
}
</code></pre>
</div>
          <pre><code class="language-javascript">self.findAll = function() {
	return PersistenceService.findAll(self.model);
};</code></pre>
          <section id="save">
            <h1>save</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>self.save()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Save the instance.</p><h2>Usage</h2>
<pre><code class="lang-javascript">function Person() {
        var self = this;
        self.ps = PersistenceService.register(Person, self);

        self.save = function() {
            var people = self.ps.save();
        }
}
</code></pre>
</div>
          <pre><code class="language-javascript">self.save = function() {
	PersistenceService.save(self.model, self.inst);
};</code></pre>
          <section id="delete">
            <h1>delete</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>self.delete()</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Delete the instance.</p><h2>Usage</h2>
<pre><code class="lang-javascript">function Person() {
        var self = this;
        self.ps = PersistenceService.register(Person, self);

        self.delete = function() {
            var people = self.ps.delete();
        }
}
</code></pre>
</div>
          <pre><code class="language-javascript">self.delete = function() {
	PersistenceService.delete(self.model, self.inst.__id);
};
};

//=============================================================================
//============================= Private Methods ===============================
//=============================================================================

PersistenceService._findAllObjs = function(key) {
var res = [];
var all = [];
try {
	all = JSON.parse(PersistenceService.storage[key]);
} catch(err) {};

for (var i in all) {
	res.push({ id: i, data: all[i] });
}
return res;
};

PersistenceService._findAll = function(model) {
var objs = PersistenceService._findAllObjs(model.name);
var models = [];
if (PersistenceService.customImport) {
	for (var i=0; i&lt;objs.length; i++) {
		var o = new model();
		try {
			o.importValues(objs[i].data);
			o.__id = objs[i].id;
		} catch(err) {
			var msg = &quot;Import of &quot; + model.name + &quot; at index &quot; + i + &quot; failed.&quot;;
			if (PersistenceService.logErrors) {
				console.log(msg);
			} else {
				throw msg;
			}
		}
		models.push(o);
	}
} else {
	models = objs;
}	
return models;
};

PersistenceService._save = function(key, inst) {
//Export the instance's data.
var data;
if (PersistenceService.customImport) {
	try {
		data = inst.exportValues();
	} catch(err) {
		var msg = &quot;Export of &quot; + key + &quot; failed.&quot;;
		if (PersistenceService.logErrors) {
			console.log(msg);
		} else {
			throw msg;
		}
	}	
} else {
	data = JSON.stringify(inst);
}
//Save the data.
var table;
try {
	table = JSON.parse(PersistenceService.storage[key]);
} catch(err) {
	table = {};
}
//Make an id if one doesn't exist.
var id = inst.__id;
if (id === undefined || id === null) {
	var indecies = Object.keys(table);
	indecies.sort(function(a,b){return parseInt(b)-parseInt(a)});
	
	id = indecies[0] ? parseInt(indecies[0]) + 1 : 0;
	inst.__id = id;
}
table[id] = data;
try {
	PersistenceService.storage[key] = JSON.stringify(table);
} catch(err) {
	var msg = &quot;Storage quota exceeded.&quot;
	if (!PersistenceService.enableCompression) {
		msg += &quot; Try enabling compression for more storage.&quot;
	}
	
	if (PersistenceService.logErrors) {
		console.log(msg);
	} else {
		throw msg;
	}
}
//Update the master table.
var tables;
try {
	tables = JSON.parse(PersistenceService.storage[PersistenceService.master])
} catch(err) {
	tables = [];
}
if (tables.indexOf(key) === -1) {
	tables.push(key);
	PersistenceService.storage[PersistenceService.master] = JSON.stringify(tables);
}
};

PersistenceService._delete = function(key, id) {
var table = JSON.parse(PersistenceService.storage[key]);
if (Object.keys(table).indexOf(String(id)) &gt; -1) {	
	delete table[id];
} else {
	var msg = &quot;No such element at index: &quot; + id;
	if (PersistenceService.logErrors) {
		console.log(msg);
	} else {
		throw msg;
	}
}
PersistenceService.storage[key] = JSON.stringify(table);
};

PersistenceService._listAll = function() {
return JSON.parse(PersistenceService.storage[PersistenceService.master]);
}</code></pre>
          <div class="footer site-footer">
            <div class="span site-footer-owner"><a href="https://github.com/mr-doc/mr-doc-theme-cayman">Cayman</a> is maintained by <a href="https://github.com/iwatakeshi">iwatakeshi</a>.</div>
            <div class="span site-footer-credits">This page was generated by <a href="https://github.com/mr-doc/mr-doc">Mr. Doc</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</div>
          </div>
        </div>
      </div>
    </section>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/affix.js"></script>
    <script src="../js/dropdown.js"></script>
    <script src="../js/scrollspy.js"></script>
    <script src="../js/prism.js"></script>
    <script src="../js/prism-bash.js"></script>
    <script>
      $(document).ready(function(){
        $('body').scrollspy({
          target: ".bs-docs-sidebar",
          offset: 40
        });
        $('#sidebar').affix({
          offset:{
            bottom:60,
            top: 60
          }
        }) 
      });
    </script>
  </body>
</html>